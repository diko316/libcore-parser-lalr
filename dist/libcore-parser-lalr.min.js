!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("libcore"),require("libcore-tokenizer")):"function"==typeof define&&define.amd?define(["exports","libcore","libcore-tokenizer"],e):e(t["libcore-parser-lalr"]={},t.libcore,t["libcore-tokenizer"])}(this,function(t,e,r){"use strict";function n(t){var e={};this.stateGen=this.symbolGen=this.reduceGen=0,e.$start={},this.root="$end",this.lookup={},this.symbol={},this.start="$start",this.states=e,this.ends={},this.exclude={},this.finalized=!1,this.rawStates=[],this.reduceLookup={},this.reducers={},this.debugMode=!0===t,this.augmentedRoot=this.generateSymbol("$end"),this.endSymbol=this.generateSymbol("$"),this.endToken="$"}function i(t){return"$"===t||!k.test(t)}function s(t,r,n){var i,s,o,a=e.regex;for(i=-1,s=n.length;s--;){if(o=n[++i],!a(o))throw new Error("Invalid Terminal pattern: "+o);if(!t.registerTerminal(o,r))throw new Error("Invalid Terminal pattern: "+o)}}function o(t,r,n){var s,o,a,u,l,h,c,d,f=e.string,p=e.regex,m=e.array,g=i;for(s=-1,o=n.length;o--;){if(u=n[++s],f(u)||p(u))u=[u];else if(!m(u))throw new Error("Invalid Grammar rule declared in "+r);for(a=u.length,h=[],c={};a--;){if(l=u[a],p(l))t.terminalExist(l)||t.registerTerminal(l),l="/"+l.source+"/",d=!0;else{if(!f(l))throw new Error("Invalid Grammar rule declared in "+r);d=g(l)}h[a]=t.map.generateSymbol(l),d&&(c[a]=!0)}t.registerRule(r,h,c)}}function a(t){this.name=t}function u(t,e){var r=t.vstates;e=e||"s"+ ++t.vstateIdGen,t.vstateLookup[e]=r[r.length]=this,this.id=e,this.registry=t,this.tags={},this.tagNames=[],this.pointer=new a,this.rparent=null,this.recursedAs={}}function l(t){var e,r,n,i,s,o,l,h,c,d,f,p,m,g,v,b,w,y,k,S,I,E,x,j,T=t.map,z=a,R=1,O=new u(t,T.start),G=new z("queue"),N=new z("pending"),L={},$=0;for(G.push([O,T.augmentedRoot]);R;)switch($++,R){case 1:if(e=G.shift(),m=e[1],(b=e[0]).isRecursed(m)){R=6;break}if(b.setRecursed(m),!(r=t.getRules(m)))throw new Error("Production is not defined: "+T.lookupSymbol(m));o=r[1],i=-1,s=(r=r[0]).length,R=2;case 2:if(!s--){R=6;break}n=r[++i],l=o[i],R=3;case 3:if(d=-1,f=l.length,h=n[0],c=l[0],(p=b).hasTag(h)){R=2;break}(k=p.findRecursion(h,c))&&(y=k.pointed(c))&&!p.pointed(c)&&p.pointTo(c,y),R=4;case 4:if(h=n[++d],w=p.hasTag(h),!f--||w){R=w?2:5;break}c=l[d],g=t.isRecursed(h),S=p.id+":"+g,!g||S in L||(L[S]=!0,(p===b?G:N).push([p,g])),p.tag(h),p=p.pointed(c)||p.point(c,b);break;case 5:h=n[d],p.tag(h),t.setEnd(p.id,m,d,h),R=2;break;case 6:!(v=G.last)&&N.last&&G.push(v=N.shift()),R=v?1:0}for(T.debugMode&&(console.log("define iterations: ",$),console.log("generated states: ",t.vstates.length)),x=-1,j=(I=t.vstates).length;j--;){for(h=(p=I[++x]).id,E=p.pointer.first,T.createState(h);E;E=E[0])e=E[1],T.createPointer(h,e[1],e[0].id);(e=t.isEnd(h))&&T.setReduceState(h,e[0],e[1],e[2])}}function h(t,e){this.tokenizer=e,this.map=t,this.productions={},this.lexemes={},this.stateIndex={},this.vstateIdGen=0,this.vstateLookup={},this.vstates=[],this.ends={},this.recursions={},this.terminals=[],this.terminalLookup={},this.symbolGen=0,this.symbol={},this.lookup={},this.stateTagIdGen=0,this.stateTagId={},this.stateTagIdLookup={}}function c(t,r,n,a,u){var c,d,f,p,m,g=e.string,v=e.array,b=e.regex,w=i,y=s,k=o,S=null,I=!0;for(r.reset(),r.root=r.generateSymbol("$"+t),p=new h(r,n),a.splice(a.length,0,r.lookupSymbol(r.augmentedRoot),[[t,r.lookupSymbol(r.endSymbol)]]),c=-1,d=a.length;d--;)if(f=a[++c],g(f))I=w(f),S=r.generateSymbol(f),f;else{if(!S||!v(f))throw new Error("Invalid item in definitions parameter.");(I?y:k)(p,S,f)}if(l(p),v(u)){for(m=[],c=-1,d=u.length;d--;){if(f=u[++c],b(f))f=p.registerTerminal(f);else{if(!g(f))throw new Error("Invalid [exclude] pattern parameter.");f=r.generateSymbol(f)}m[c]=f}r.setExcludes(m)}return!0}function d(t){this.terminal=!1,this.useType(t)}function f(t){if(!e.object(t))throw new Error("Invalid parser parameter.");this.parser=t,this.reset(),this.start=":start"}function p(t,r){var n=f;if(!e.string(t))throw new Error("Invalid iterator name parameter.");if(!e.method(r)||r!==n&&!(r.prototype instanceof n))throw new Error("Invalid iterator Class parameter.");return I[":"+t]=r,!0}function m(t){var r=I;return e.string(t)&&(t=":"+t)in r?r[t]:null}function g(t,e,i){this.tokenizer=new r,this.map=new n(E),arguments.length&&this.define(t,e,i)}function v(t){E=!1!==t}function b(t,e,r){return new g(t,e,r)}function w(t){var r;if(e.string(t))try{t=JSON.parse(t)}catch(t){throw new Error("Unable to load from invalid json JSON String parameter: "+t.toString())}else if(!e.object(t))throw new Error("Unable to load from invalid json Object parameter.");r=new g;try{r.fromJSON(t)}catch(t){throw new Error(t)}return r}function y(t){return t instanceof g}r=r&&r.hasOwnProperty("default")?r.default:r,n.prototype={stateGen:0,rawStates:null,debugMode:!1,constructor:n,createState:function(t){var e=this.states;return t in e?e[t]:e[t]={}},createPointer:function(t,e,r){var n=this.createState(t);return n[e]=r,n},generateSymbol:function(t){var e,r=this.lookup,n=this.symbol,i=":"+t;return i in r?r[i]:(e=this.debugMode?"["+t+"]":"s"+(++this.symbolGen).toString(16),r[i]=e,n[e]=t,e)},generateReduceId:function(t,e,r){var n,i=this.reduceLookup,s=this.reducers,o=t+":"+e+":"+r;return o in i?i[o]:(n=this.debugMode?"["+t+":"+e+">"+r+"]":"<"+(++this.reduceGen).toString(16),i[o]=n,s[n]=[t,e,r],n)},lookupReducer:function(t){var e=this.reducers;return t in e&&e[t]},lookupSymbol:function(t){var e=this.symbol;return t in e&&e[t]},setReduceState:function(t,e,r,n){var i,s=this.ends,o=this.generateReduceId(e,r,n),a=this.reducers;if(t in s){if((i=a[s[t]])[0]!==e||i[1]!==r)throw new Error("Reduce conflict found "+this.lookupSymbol(i[0])+" ! <- "+this.lookupSymbol(e))}else s[t]=o},reset:function(){this.constructor(this.debugMode)},finalize:function(){var t,e,r=this.rawStates;if(!this.finalized&&r){for(this.finalized=!0,t=-1,e=r.length;e--;)r[++t].finalize();r.length=0,delete this.lookup}return this.finalized},setExcludes:function(t){var r,n,i=this.exclude;if(e.array(t))for(r=-1,n=t.length;n--;)i[t[++r]]=!0},importStates:function(t){var r,n,i,s,o,a,u,l,h,c,d=e.object,f=e.string;if(!d(t))throw new Error("Invalid Object definition parameter.");if(n=t.states,!d(n))throw new Error('Invalid "states" Object in definition parameter.');if(s=t.root,!f(s))throw new Error('Invalid "root" grammar rule in definition parameter.');if(r=t.start,!(f(r)&&r in n))throw new Error('Invalid "start" state in definition parameter.');if(i=t.ends,!d(i))throw new Error('Invalid "ends" states in definition parameter.');if(u=t.reducers,!d(u))throw new Error('Invalid production "reducers" in definition.');if(a=t.symbol,!d(a))throw new Error('Invalid "symbol" map in definition parameter.');if(l=t.exclude,!e.array(l))throw new Error('Invalid "exclude" token in definition parameter.');for(o={},h=-1,c=l.length;c--;)o[l[++h]]=!0;return this.root=s,this.start=r,this.states=n,this.ends=i,this.reducers=u,this.exclude=o,this.symbol=a,!0},toObject:function(){var t,r=e.contains,n=this.exclude,i=[],s=0;for(t in n)r(n,t)&&(i[s++]=t);return{root:this.root,start:this.start,states:this.states,reducers:this.reducers,ends:this.ends,exclude:i,symbol:this.symbol}},exportStates:function(t){var e=this.toObject();if(!0===t)try{return JSON.stringify(e)}catch(t){return null}return e}};var k=/^([A-Z][a-zA-Z]+(\_?[a-zA-Z0-9])*|\$end|\$)$/;a.prototype={constructor:a,first:null,last:null,shift:function(){var t,e=this.first;return e?(this.first=t=e[0],t||(this.last=t),e[1]):null},push:function(t){return t=[null,t],this.last?this.last[0]=t:this.first=t,this.last=t,this}},u.prototype={pointer:null,registry:null,constructor:u,tag:function(t){var e=this.tags,r=this.tagNames;return t in e||(e[t]=!0,r[r.length]=t),this},hasTag:function(t){return t in this.tags},setRecursed:function(t){var e=":"+t,r=this.recursedAs;return e in r||(r[e]=!0),this},isRecursed:function(t){return":"+t in this.recursedAs},findRecursion:function(t){for(var e=this.rparent;e;e=e.rparent)if(e.hasTag(t))return e;return null},pointed:function(t){for(var e,r=this.pointer.first;r;r=r[0])if((e=r[1])[1]===t)return e[0];return null},pointTo:function(t,e){return this.pointer.push([e,t]),e},point:function(t,e){var r,n=this.pointed(t);return n||(r=new u(this.registry),r.rparent=e,this.pointTo(t,r))}},h.prototype={constructor:h,startRule:null,rules:null,hashState:function(t){var e,r=this.stateTagIdLookup,n=":"+t;return n in r?r[n]:(e=this.map.debugMode?":"+t:"t"+(++this.stateTagIdGen).toString(16),r[n]=e,this.stateTagId[e]=t,e)},lookupState:function(t){var e=this.stateTagId;return t in e?e[t]:null},hashLexeme:function(t){var e,r=this.lookup,n=this.symbol,i=":"+t;return i in r?r[i]:(e=this.map.debugMode?"["+t+"]":">"+(++this.symbolGen).toString(16),r[i]=e,n[e]=t,e)},lookupLexeme:function(t){var e=this.lookup;return t in e?e[t]:null},terminalExist:function(t){var r=this.terminalLookup;return e.string(t)?e.contains(r,t):"/"+t.source+"/"in r},registerTerminal:function(t,r){var n,i=this.terminalLookup,s=this.terminals,o=this.map.generateSymbol("/"+t.source+"/");return r||(r=o),!(o in i)&&(i[o]=r,o===r?s[s.length]=r:e.contains(i,r)?(n=i[r])[n.length]=o:(s[s.length]=r,i[r]=[o]),this.tokenizer.define([r,t]),r)},registerRule:function(t,e,r){var n,i,s,o,a,u=this,l=this.stateIndex,h=this.recursions,c=this.productions,d=this.lexemes,f=[],p=0,m=-1,g=e.length+1;t in c||(c[t]=[],d[t]=[]),(o=c[t])[a=o.length]=f,d[t][a]=e;for(;g--;){if(s=e[++m],(n=e.slice(0)).splice(m,0,"."),(i=u.hashState(t+" -> "+n.join(" ")))in l)throw new Error("Duplicate Grammar Rule found "+u.lookupState(i)+" in production: "+u.map.lookupSymbol(t));f[p++]=i,l[i]=i,!g||m in r||(h[i]=s)}},getRules:function(t){var e=this.productions;return t in e?[e[t],this.lexemes[t]]:null},isRecursed:function(t){var e=this.recursions;return t in e&&e[t]},setEnd:function(t,e,r,n){var i=this.ends,s=this.map,o=this.vstateLookup[t];if(t in i){if(i[t][0]!==e)throw new Error("Reduce conflict! "+o.id+":"+s.lookupSymbol(i[t][0])+" <- "+s.lookupSymbol(e))}else i[t]=[e,r,n]},isEnd:function(t){var e=this.ends;return t in e&&e[t]}};var S={terminal:1,nonterminal:2,compound:3,end:4};d.prototype={constructor:d,name:null,rule:null,value:null,reduceCount:0,from:0,to:0,parent:null,first:null,last:null,next:null,previous:null,terminal:!1,useType:function(t){var r=S;this.type=t=e.contains(r,t)?r[t]:r.token,t===S.terminal&&(this.terminal=!0)}};f.prototype={constructor:f,subject:"",returns:!1,current:null,ready:!1,completed:!1,error:null,actions:{":start":{0:":fail",1:":tokenize"},":tokenize":{0:":fail",1:":tokenize",2:":shift",3:":reduce"},":shift":{0:":fail",1:":tokenize"},":reduce":{0:":fail",1:":shift",2:":reduce",3:":success"},":fail":{},":success":{}},":start":function(){var t=this;return t.params=t.nextTokenIndex,1},":tokenize":function(t){var e,r,n,i,s,o=this,a=o.parser,u=a.map,l=u.ends,h=u.states,c=o.pstate,f=a.tokenizer.tokenize(t,o.subject),p=u.endToken;if(f){if(e=f[0],r=f[2],!this.isAcceptableToken(f))return o.params=r,1;if(i=new d("terminal"),s=e,e===p?e=u.endSymbol:s=u.symbol[e],i.name=s,i.symbol=e,i.value=f[1],i.from=t,i.to=r,o.nextTokenIndex=r,o.params=i,n=h[c],e in n)return 2}return o.buffer.length&&c in l?3:(o.params="Invalid token",0)},":shift":function(t){var e=this,r=e.buffer,n=e.parser.map,i=n.states,s=e.pstate,o=t.symbol;return r[r.length]=[s,t],e.pstate=i[s][o],e.current=t,e.params=null,e.returns=o!==n.endSymbol,e.params=e.nextTokenIndex,1},":reduce":function(t){var e,r,n,i,s,o,a=this,u=a.parser.map,l=a.buffer,h=l.length,c=u.ends,f=u.states,p=u.symbol,m=a.pstate,g=u.lookupReducer(c[m]),v=g[0],b=g[1],w=b,y=w-1,k=new d("nonterminal"),S=[];for(k.name=p[v],k.symbol=v,k.rule=p[g[2]],o=null;w--;)m=(r=l[--h])[0],n=(e=r[1]).from,w===y&&(i=e.to),e.parent=k,o?(o.previous=e,e.next=o):k.last=e,k.first=o=e,S[w]=e.value;return k.value=S,k.from=n,k.to=i,l.length=h,a.current=k,k.reduceCount=b,v===u.augmentedRoot?0===h?(e=k.first,k.useType("end"),k.last=e,k.value=[e.value],k.rule=p[u.root],k.reduceCount=1,a.params=k,3):(a.params="Failed last reduce",0):(l[h++]=[m,k],a.returns=!0,m=f[m][v],s=f[m],v=t.symbol,a.pstate=m,v in s?1:m in c?2:(a.params="failed reduce! inside :reduce",0))},":success":function(t){var e=this;return e.completed=e.returns=!0,e.current=t,!1},":fail":function(t){var e=this;return e.error=t,e.completed=!0,!1},isAcceptableToken:function(t){return!(t[0]in this.parser.map.exclude)},update:function(t){var e=this,r=e.current;return!e.error&&r&&(r.value=t),this},reset:function(){var t=this.parser;this.nextTokenIndex=0,this.cursor=0,this.buffer=[],this.state=this.start,this.pstate=t.map.start,this.params=null,this.subject||delete this.ready,delete this.complete,delete this.error,delete this.returns,delete this.current},set:function(t){if(!e.string(t))throw new Error("Invalid String subject parameter.");this.reset(),this.subject=t,this.ready=!0},next:function(){var t,r,n,i,s,o=this,a=o.actions,u=e.number,l=o.completed,h=!1;if(!o.ready)throw new Error("Iterator is not yet ready, nothing to Parse.");for(l||delete o.current;!l;){if(t=o.state,r=o.params,!(t in o))throw new Error("No handler found for state "+t);if(n=o[t](r),h=o.returns,delete o.returns,s=o.current,l=o.completed,o.error)break;if(!l){if(!u(n))throw new Error("Invalid result from state handler"+t);if(i=a[t],!(n in i))throw new Error("Invalid result from state handler"+t);o.state=i[n]}if(!0===h)return s}return!(o.error||!l)&&null}};var I={};p("base",f);var E=!1;g.prototype={subject:"",tokenizer:null,map:null,ready:!1,constructor:g,iterator:function(t){var e,r=m;if(arguments.length){if(!(e=r(t)))throw new Error("Invalid iterator name parameter.")}else e=r("base");return new e(this)},define:function(t,r,n){var i,s=e.array;if(s(n)||(n=[]),!e.string(t))throw new Error("Invalid root grammar rule parameter.");if(!s(r))throw new Error("Invalid grammar rules definition parameter");return this.ready=i=c(t,this.map,this.tokenizer,r,n),i},fromJSON:function(t){var r,n=e.object;if(e.string(t))try{t=JSON.parse(t)}catch(t){throw new Error("Invalid JSON String json parameter.")}if(!n(t))throw new Error("Invalid Object json parameter.");if(r=t.tokens,!n(r))throw new Error('Invalid "tokens" property of json parameter.');return this.tokenizer.fromJSON(r),this.map.importStates(t),this},toJSON:function(){return JSON.stringify(this.toObject())},toObject:function(){var t;if(!this.ready)throw new Error("Grammar rules is not yet defined.");return t=this.map.toObject(),t.tokens=this.tokenizer.toObject(),t},parse:function(t,r,n){var i,s,o,a=e.string,u=[],l=0;if(!a(t))throw new Error("Invalid string subject parameter");if(!(n=a(n)?this.iterator(n):this.iterator()))throw new Error("Invalid Iterator parameter.");for(e.object(r)||(r={}),n.set(t),i=n.next();i;i=n.next())u[l++]=i,(s=i.name)in r&&(void 0!==(o=r[s](s,i.value,i))?i.value=o:0!==i.params&&(i.value=null));return!n.error&&u}};var x=Object.freeze({debug:v,Parser:g,define:b,load:w,isParser:y,Iterator:f,registerIterator:p});t.default=x,t.debug=v,t.Parser=g,t.define=b,t.load=w,t.isParser=y,t.Iterator=f,t.registerIterator=p,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=libcore-parser-lalr.min.js.map
