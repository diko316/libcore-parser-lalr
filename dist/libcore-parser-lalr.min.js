!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("libcore"),require("libcore-tokenizer")):"function"==typeof define&&define.amd?define(["exports","libcore","libcore-tokenizer"],t):t(e["libcore-parser-lalr"]={},e.libcore,e["libcore-tokenizer"])}(this,function(e,t,r){"use strict";function n(){this.reset()}function i(){}function a(e){var t=i;return t.prototype=e,new t}function o(e,t){this.item=e,this.to=t}function s(e,t){var r=t.rawStates;this.map=t,this.state=e=e||t.generateState(),this.base=this,this.watched=[],this.reduceList=[],r[r.length]=this}function u(e,t,r){var n,i,a,o,u,l,f,c,h,d,p=1,m=e.rules,w=e.ruleGroup;for(t.reset(),t.root=e.root,r&&t.setExcludes(r),f=new s(t.start,t);p;)switch(p){case 1:if(!f){p=0;break}n=f,a=m[i=f.lexeme],p=2,h=null;case 2:if(!a){p=5;break}if(u=a[0],o=a[1],a=a[2],!1===u){l=0,f=d=n;break}if(l++,o in m){if(c=d.getRecursionItem(u)){for(c.watchItem(d);a&&!1!==a[0];a=a[2]);break}c=d.createRecursion(u,o),f===n?f.insertNextQueue(c):h?h.appendQueue(c):h=c}d=d.point(o),a&&!1!==a[0]||d.reduce(i,l,w[u]);break;case 5:h&&f.appendQueue(h),f=f.nextInQueue,p=1}return!0}function l(e,r,n,i){var a,o,s,u,l,f,c,h,d,p,m=n.rules,w=n.ruleIndex,v=n.terminal,x=n.lexIndex,g=n.ruleNames,b=I,E=t.string,y=t.regex;if((E(r)||y(r))&&(r=[r]),!t.array(r))throw new Error("Invalid grammar rule found in "+e);for(c=h=null,s=[],a=r.length;a--;){if(o=r[a],y(o))o.source,(u="/"+o.source+"/")in v||(i.define([u,o]),v[u]=u),o=u;else{if(!E(o))throw new Error("Invalid token in grammar rule "+o);if(!b.test(o))throw new Error("Invalid grammar rule name format: "+o)}s[a]=o,x[p="r"+ ++n.rgenId]=o,l=[p,o,c],c||(h=l),c=l}if(f=" -> "+s.join(","),e+":",(u=e+f)in w)throw new Error("Grammar rule is already defined "+e+f);return w[u]=!0,e in m||(m[e]=null,g[g.length]=e),c=[!1,null,c],(d=m[e])&&(h[2]=d),m[e]=c,[c[2][0],h[0]]}function f(e,r,n,i,a){var o,s,f,c,h,d,p,m,w,v,x=t.string,g=t.array,b=t.regex,E=l,y=I;for(h=null,m={root:"$"+e,rgenId:0,ruleNames:[],rules:p={},terminal:v={},lexIndex:{},ruleIndex:{},ruleGroup:w={}},i.splice(i.length,0,"$end",[[e,"$"]]),o=-1,s=i.length;s--;)if(d=i[++o],x(d)){if(!y.test(d))throw new Error("Invalid grammar rule name "+d);h=d}else{if(!g(d))throw new Error("Invalid item in definitions parameter.");if(!h)throw new Error("Invalid grammar rules parameter.");for(f=-1,c=d.length;c--;)w[E(h,d[++f],m,n)[1]]=h+(f+1)}if(a)for(s=(a=a.slice(0)).length;s--;){if(d=a[s],!b(d))throw new Error("Invalid exclude token parameter.");(h="/"+d.source+"/")in v?a.splice(s,1):(n.define([h,d]),v[h]=h,a[s]=h)}if(!t.contains(p,e))throw new Error("Invalid root grammar rule parameter.");return u(m,r,a)&&r.finalize()}function c(e){this.useType(e)}function h(e){if(!t.object(e))throw new Error("Invalid parser parameter.");this.parser=e,this.reset(),this.start=":start"}function d(e,r){var n=h;if(!t.string(e))throw new Error("Invalid iterator name parameter.");if(!t.method(r)||r!==n&&!(r.prototype instanceof n))throw new Error("Invalid iterator Class parameter.");return b[":"+e]=r,!0}function p(e){var r=b;return t.string(e)&&(e=":"+e)in r?r[e]:null}function m(e,t,i){this.tokenizer=new r,this.map=new n,arguments.length&&this.define(e,t,i)}function w(e,t,r){return new m(e,t,r)}function v(e){var r;if(t.string(e))try{e=JSON.parse(e)}catch(e){throw new Error("Unable to load from invalid json JSON String parameter: "+e.toString())}else if(!t.object(e))throw new Error("Unable to load from invalid json Object parameter.");r=new m;try{r.fromJSON(e)}catch(e){throw new Error(e)}return r}function x(e){return e instanceof m}r=r&&r.hasOwnProperty("default")?r.default:r,n.prototype={stateGen:0,rawStates:null,constructor:n,generateState:function(){var e="s"+ ++this.stateGen;return this.states[e]={},e},setAnchorState:function(e){e in this.anchors||(this.anchors[e]=!0)},setReduceState:function(e,t,r,n){var i,a=this.ends;if(e in a){if((i=a[e])[0]!==t||i[1]!==r)throw new Error("Reduce conflict found "+i[0]+" ! <- "+t)}else a[e]=[t,r,n]},reset:function(){var e={};e.$start={},this.root="$end",this.start="$start",this.states=e,this.anchors={},this.ends={},this.exclude={},this.finalized=!1,this.rawStates=[]},finalize:function(){var e,t,r=this.rawStates;if(!this.finalized&&r){for(this.finalized=!0,e=-1,t=r.length;t--;)r[++e].finalize();r.length=0}return this.finalized},setExcludes:function(e){var r,n,i=this.exclude;if(t.array(e))for(r=-1,n=e.length;n--;)i[e[++r]]=!0},importStates:function(e){var r,n,i,a,o,s,u=t.object,l=t.string;if(!u(e))throw new Error("Invalid Object definition parameter.");if(n=e.states,!u(n))throw new Error('Invalid "states" Object in definition parameter.');if(o=e.root,!l(o))throw new Error('Invalid "root" grammar rule in definition parameter.');if(r=e.start,!(l(r)&&r in n))throw new Error('Invalid "start" state in definition parameter.');if(i=e.anchors,!u(i))throw new Error('Invalid "anchors" states in definition parameter.');if(a=e.ends,!u(i))throw new Error('Invalid "ends" states in definition parameter.');if(s=e.exclude,!u(s))throw new Error('Invalid "exclude" token in definition parameter.');return this.root=o,this.start=r,this.states=n,this.anchors=i,this.ends=a,this.exclude=s,!0},toObject:function(){return{root:this.root,start:this.start,states:this.states,anchors:this.anchors,ends:this.ends,exclude:this.exclude}},exportStates:function(e){var t=this.toObject();if(!0===e)try{return JSON.stringify(t)}catch(e){return null}return t}},o.prototype={constructor:o,next:null,item:null,to:null},s.prototype={state:null,constructor:s,nextInQueue:null,parent:null,map:null,pointer:null,watched:null,contextPointer:null,reduceList:null,lexeme:"$end",recursion:{},finalized:!1,getRecursionItem:function(e){var t=this.recursion;return e in t?t[e]:null},insertNextQueue:function(e){var t=this.nextInQueue,r=e;for(this.nextInQueue=e;r.nextInQueue;r=r.nextInQueue);r.nextInQueue=t},appendQueue:function(e){for(var t=this;t.nextInQueue;t=t.nextInQueue);t.nextInQueue=e},createRecursion:function(e,t){var r=a,n=r(this),i=r(this.recursion);return n.parent=this,n.lexeme=t,n.recursion=i,i[e]=n,n.contextPointer=n.nextInQueue=null,n},getPointerItem:function(e){for(var t=this.pointer;t;t=t.next)if(t.item===e)return t.to;return null},point:function(e){var t,r,n,i,a=o,u=this.getPointerItem(e);if(!u)for((u=new s(null,this.map)).lexeme=e,u.recursion=this.recursion,this.onSetPointer(new a(e,u)),r=-1,n=(t=this.watched).length;n--;)(i=t[++r]).getPointerItem(e)||i.onSetPointer(new a(e,u));return u},watchItem:function(e){var t,r,n=this.watched,i=o;if(e.state!==this.state&&-1===n.indexOf(e))for(n[n.length]=e,t=this.pointer;t;t=t.next)r=t.item,e.getPointerItem(r)||e.onSetPointer(new i(r,t.to))},onSetPointer:function(e){var t,r=this.pointer,n=this.contextPointer;if(r){for(;r.next;r=r.next);r.next=e}else this.base.pointer=e;if(!n)for(t=this;t;t=t.parent)t.contextPointer||(t.contextPointer=e)},finalize:function(){var e,t,r,n,i,a=this.map,o=this.state,s=a.states[o];for(n=this.pointer;n;n=n.next)(i=n.item)in s||(s[i]=n.to.state);for(t=-1,r=(e=this.reduceList).length;r--;)n=e[++t],a.setReduceState(o,n[0],n[1],n[2])},reduce:function(e,t,r){var n=this.reduceList;n[n.length]=[e,t,r]}};var I=/^([A-Z][a-zA-Z]+(\_?[a-zA-Z0-9])*|\$end|\$)$/,g={terminal:1,nonterminal:2,compound:3};c.prototype={constructor:c,name:null,rule:null,value:null,reduceCount:0,from:0,to:0,parent:null,first:null,last:null,next:null,previous:null,useType:function(e){var r=g;this.type=t.contains(r,e)?r[e]:r.token}};h.prototype={constructor:h,subject:"",returns:!1,current:null,ready:!1,completed:!1,error:null,actions:{":start":{0:":fail",1:":tokenize"},":tokenize":{0:":fail",1:":tokenize",2:":shift",3:":reduce"},":shift":{0:":fail",1:":tokenize"},":reduce":{0:":fail",1:":shift",2:":reduce",3:":success"},":fail":{},":success":{}},":start":function(){var e=this;return e.params=e.nextTokenIndex,1},":tokenize":function(e){var t,r,n,i,a=this,o=a.parser,s=o.map,u=s.ends,l=s.states,f=a.pstate,h=o.tokenizer.tokenize(e,a.subject);if(h){if(t=h[0],r=h[2],!this.isAcceptableToken(h))return a.params=r,1;if(i=new c("terminal"),i.name=t,i.value=h[1],i.from=e,i.to=r,a.nextTokenIndex=r,a.params=i,n=l[f],t in n)return 2}return a.buffer.length&&f in u?3:(a.params="Invalid token",0)},":shift":function(e){var t=this,r=t.buffer,n=t.parser.map.states,i=t.pstate,a=e.name;return r[r.length]=[i,e],t.pstate=n[i][a],t.current=e,t.params=null,t.returns="$"!==a,t.params=t.nextTokenIndex,1},":reduce":function(e){var t,r,n,i,a,o,s=this,u=s.parser.map,l=s.buffer,f=l.length,h=u.ends,d=u.states,p=s.pstate,m=h[p],w=m[0],v=m[1],x=v,I=x-1,g=new c("nonterminal"),b=[];for(g.name=w,g.rule=m[2],o=null;x--;)p=(r=l[--f])[0],n=(t=r[1]).from,x===I&&(i=t.to),t.parent=g,o?(o.previous=t,t.next=o):g.last=t,g.first=o=t,b[x]=t.value;return g.value=b,g.from=n,g.to=i,l.length=f,s.current=g,g.reduceCount=v,"$end"===w?0===f?(t=g.first,g.useType("end"),g.last=t,g.value=[t.value],g.rule=u.root,g.reduceCount=1,s.params=g,3):(s.params="Failed last reduce",0):(l[f++]=[p,g],s.returns=!0,p=d[p][w],a=d[p],w=e.name,s.pstate=p,w in a?1:p in h?2:(s.params="failed reduce! inside :reduce",0))},":success":function(e){var t=this;return t.completed=t.returns=!0,t.current=e,!1},":fail":function(e){var t=this;return t.error=e,t.completed=!0,!1},isAcceptableToken:function(e){return!(e[0]in this.parser.map.exclude)},update:function(e){var t=this,r=t.current;return!t.error&&r&&(r.value=e),this},reset:function(){var e=this.parser;this.nextTokenIndex=0,this.cursor=0,this.buffer=[],this.state=this.start,this.pstate=e.map.start,this.params=null,this.subject||delete this.ready,delete this.complete,delete this.error,delete this.returns,delete this.current},set:function(e){if(!t.string(e))throw new Error("Invalid String subject parameter.");this.reset(),this.subject=e,this.ready=!0},next:function(){var e,r,n,i,a,o=this,s=o.actions,u=t.number,l=o.completed,f=!1;for(l||delete o.current;!l;){if(e=o.state,r=o.params,!(e in o))throw new Error("No handler found for state "+e);if(n=o[e](r),f=o.returns,delete o.returns,a=o.current,l=o.completed,o.error)break;if(!l){if(!u(n))throw new Error("Invalid result from state handler"+e);if(i=s[e],!(n in i))throw new Error("Invalid result from state handler"+e);o.state=i[n]}if(!0===f)return a}return!(o.error||!l)&&null}};var b={};d("base",h),m.prototype={subject:"",tokenizer:null,map:null,ready:!1,constructor:m,iterator:function(e){var t,r=p;if(arguments.length){if(!(t=r(e)))throw new Error("Invalid iterator name parameter.")}else t=r("base");return new t(this)},define:function(e,r,n){var i,a=t.array;if(a(n)||(n=[]),!t.string(e))throw new Error("Invalid root grammar rule parameter.");if(!a(r))throw new Error("Invalid grammar rules definition parameter");return this.ready=i=f(e,this.map,this.tokenizer,r,n),i},fromJSON:function(e){var r,n=t.object;if(t.string(e))try{e=JSON.parse(e)}catch(e){throw new Error("Invalid JSON String json parameter.")}if(!n(e))throw new Error("Invalid Object json parameter.");if(r=e.tokens,!n(r))throw new Error('Invalid "tokens" property of json parameter.');return this.tokenizer.fromJSON(r),this.map.importStates(e),this},toJSON:function(){return JSON.stringify(this.toObject())},toObject:function(){var e;if(!this.ready)throw new Error("Grammar rules is not yet defined.");return e=this.map.toObject(),e.tokens=this.tokenizer.toObject(),e},parse:function(e,r,n){var i,a,o,s=t.string,u=[],l=0;if(!s(e))throw new Error("Invalid string subject parameter");if(!(n=s(n)?this.iterator(n):this.iterator()))throw new Error("Invalid Iterator parameter.");for(t.object(r)||(r={}),n.set(e),i=n.next();i;i=n.next())u[l++]=i,(a=i.name)in r&&(void 0!==(o=r[a](a,i.value,i))?i.value=o:0!==i.params&&(i.value=null));return!n.error&&u}};var E=Object.freeze({Parser:m,define:w,load:v,isParser:x,Iterator:h,registerIterator:d});e.default=E,e.Parser=m,e.define=w,e.load=v,e.isParser=x,e.Iterator=h,e.registerIterator=d,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=libcore-parser-lalr.min.js.map
