!function(r,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("libcore"),require("libcore-tokenizer")):"function"==typeof define&&define.amd?define(["exports","libcore","libcore-tokenizer"],e):e(r["libcore-parser-lalr"]={},r.libcore,r["libcore-tokenizer"])}(this,function(r,e,t){"use strict";function n(){this.reset()}function i(){}function a(r){var e=i;return e.prototype=r,new e}function o(r,e){this.id=e,this.map=r,this.pointer={},this.lexemes=[]}function s(r,e,t){var n,i,a,s,u,l,f,c,h,d,p=o,m=r.rules,w=r.ruleGroup,v=new p(e,e.start),g=[[v,"$end"]],I=1;for(e.reset(),e.root=r.root,t&&e.setExcludes(t);I--;)for(u=(n=g.splice(0,1)[0])[0],a=m[i=n[1]];a;a=d)l=a[0],d=a[2],!1===l?(f=0,v=u):(f++,(s=a[1])in m&&((h=i+":"+l)in v||((c=v.clone())[h]=c,g[I++]=[c,s])),v=v.point(s),d&&!1!==d[0]||v.reduce(i,f,w[l]));return!0}function u(r,t,n,i){var a,o,s,u,l,f,c,h,d,p,m=n.rules,w=n.ruleIndex,v=n.terminal,I=n.lexIndex,b=n.ruleNames,x=g,E=e.string,y=e.regex;if((E(t)||y(t))&&(t=[t]),!e.array(t))throw new Error("Invalid grammar rule found in "+r);for(c=h=null,s=[],a=t.length;a--;){if(o=t[a],y(o))o.source,(u="/"+o.source+"/")in v||(i.define([u,o]),v[u]=u),o=u;else{if(!E(o))throw new Error("Invalid token in grammar rule "+o);if(!x.test(o))throw new Error("Invalid grammar rule name format: "+o)}s[a]=o,I[p="r"+ ++n.rgenId]=o,l=[p,o,c],c||(h=l),c=l}if(f=" -> "+s.join(","),r+":",(u=r+f)in w)throw new Error("Grammar rule is already defined "+r+f);return w[u]=!0,r in m||(m[r]=null,b[b.length]=r),c=[!1,null,c],(d=m[r])&&(h[2]=d),m[r]=c,[c[2][0],h[0]]}function l(r,t,n,i,a){var o,l,f,c,h,d,p,m,w,v,I=e.string,b=e.array,x=e.regex,E=u,y=g;for(h=null,m={root:"$"+r,rgenId:0,ruleNames:[],rules:p={},terminal:v={},lexIndex:{},ruleIndex:{},ruleGroup:w={}},i.splice(i.length,0,"$end",[[r,"$"]]),o=-1,l=i.length;l--;)if(d=i[++o],I(d)){if(!y.test(d))throw new Error("Invalid grammar rule name "+d);h=d}else{if(!b(d))throw new Error("Invalid item in definitions parameter.");if(!h)throw new Error("Invalid grammar rules parameter.");for(f=-1,c=d.length;c--;)w[E(h,d[++f],m,n)[1]]=h+(f+1)}if(a)for(l=(a=a.slice(0)).length;l--;){if(d=a[l],!x(d))throw new Error("Invalid exclude token parameter.");(h="/"+d.source+"/")in v?a.splice(l,1):(n.define([h,d]),v[h]=h,a[l]=h)}if(!e.contains(p,r))throw new Error("Invalid root grammar rule parameter.");return s(m,t,a)}function f(r){this.useType(r)}function c(r){if(!e.object(r))throw new Error("Invalid parser parameter.");this.parser=r,this.reset(),this.start=":start"}function h(r,t){var n=c;if(!e.string(r))throw new Error("Invalid iterator name parameter.");if(!e.method(t)||t!==n&&!(t.prototype instanceof n))throw new Error("Invalid iterator Class parameter.");return b[":"+r]=t,!0}function d(r){var t=b;return e.string(r)&&(r=":"+r)in t?t[r]:null}function p(r,e,i){this.tokenizer=new t,this.map=new n,arguments.length&&this.define(r,e,i)}function m(r,e,t){return new p(r,e,t)}function w(r){var t;if(e.string(r))try{r=JSON.parse(r)}catch(r){throw new Error("Unable to load from invalid json JSON String parameter: "+r.toString())}else if(!e.object(r))throw new Error("Unable to load from invalid json Object parameter.");t=new p;try{t.fromJSON(r)}catch(r){throw new Error(r)}return t}function v(r){return r instanceof p}t=t&&t.hasOwnProperty("default")?t.default:t,n.prototype={stateGen:0,constructor:n,generateState:function(){var r="s"+ ++this.stateGen;return this.states[r]={},r},setAnchorState:function(r){r in this.anchors||(this.anchors[r]=!0)},setReduceState:function(r,e,t,n){var i,a=this.ends;if(r in a){if((i=a[r])[0]!==e||i[1]!==t)throw new Error("Reduce conflict found "+i[0]+" ! <- "+e)}else a[r]=[e,t,n]},reset:function(){var r={};r.$start={},this.root="$end",this.start="$start",this.states=r,this.anchors={},this.ends={},this.exclude={}},setExcludes:function(r){var t,n,i=this.exclude;if(e.array(r))for(t=-1,n=r.length;n--;)i[r[++t]]=!0},importStates:function(r){var t,n,i,a,o,s,u=e.object,l=e.string;if(!u(r))throw new Error("Invalid Object definition parameter.");if(n=r.states,!u(n))throw new Error('Invalid "states" Object in definition parameter.');if(o=r.root,!l(o))throw new Error('Invalid "root" grammar rule in definition parameter.');if(t=r.start,!(l(t)&&t in n))throw new Error('Invalid "start" state in definition parameter.');if(i=r.anchors,!u(i))throw new Error('Invalid "anchors" states in definition parameter.');if(a=r.ends,!u(i))throw new Error('Invalid "ends" states in definition parameter.');if(s=r.exclude,!u(s))throw new Error('Invalid "exclude" token in definition parameter.');return this.root=o,this.start=t,this.states=n,this.anchors=i,this.ends=a,this.exclude=s,!0},toObject:function(){return{root:this.root,start:this.start,states:this.states,anchors:this.anchors,ends:this.ends,exclude:this.exclude}},exportStates:function(r){var e=this.toObject();if(!0===r)try{return JSON.stringify(e)}catch(r){return null}return e}},o.prototype={constructor:o,id:null,pointer:null,parent:null,rid:null,lexemes:null,clone:function(r){var e=a(this);return r&&(e.rid=r),e.parent=this,e},point:function(r){var e,t,n=this.pointer,i=this.lexemes,a=this.map;return r in n||(t=this.map.generateState(),(e=this.clone()).id=t,e.pointer={},e.lexemes=[],i[i.length]=r,n[r]=e,a.states[this.id][r]=t),n[r]},reduce:function(r,e,t){this.map.setReduceState(this.id,r,e,t)}};var g=/^([A-Z][a-zA-Z]+(\_?[a-zA-Z0-9])*|\$end|\$)$/,I={terminal:1,nonterminal:2,compound:3};f.prototype={constructor:f,name:null,rule:null,value:null,reduceCount:0,from:0,to:0,parent:null,first:null,last:null,next:null,previous:null,useType:function(r){var t=I;this.type=e.contains(t,r)?t[r]:t.token}};c.prototype={constructor:c,subject:"",returns:!1,current:null,ready:!1,completed:!1,error:null,actions:{":start":{0:":fail",1:":tokenize"},":tokenize":{0:":fail",1:":tokenize",2:":shift",3:":reduce"},":shift":{0:":fail",1:":tokenize"},":reduce":{0:":fail",1:":shift",2:":reduce",3:":success"},":fail":{},":success":{}},":start":function(){var r=this;return r.params=r.nextTokenIndex,1},":tokenize":function(r){var e,t,n,i,a=this,o=a.parser,s=o.map,u=s.ends,l=s.states,c=a.pstate,h=o.tokenizer.tokenize(r,a.subject);if(h){if(e=h[0],t=h[2],!this.isAcceptableToken(h))return a.params=t,1;if(i=new f("terminal"),i.name=e,i.value=h[1],i.from=r,i.to=t,a.nextTokenIndex=t,a.params=i,n=l[c],e in n)return 2}return a.buffer.length&&c in u?3:(a.params="Invalid token",0)},":shift":function(r){var e=this,t=e.buffer,n=e.parser.map.states,i=e.pstate,a=r.name;return t[t.length]=[i,r],e.pstate=n[i][a],e.current=r,e.params=null,e.returns="$"!==a,e.params=e.nextTokenIndex,1},":reduce":function(r){var e,t,n,i,a,o,s=this,u=s.parser.map,l=s.buffer,c=l.length,h=u.ends,d=u.states,p=s.pstate,m=h[p],w=m[0],v=m[1],g=v,I=g-1,b=new f("nonterminal"),x=[];for(b.name=w,b.rule=m[2],o=null;g--;)p=(t=l[--c])[0],n=(e=t[1]).from,g===I&&(i=e.to),e.parent=b,o?(o.previous=e,e.next=o):b.last=e,b.first=o=e,x[g]=e.value;return b.value=x,b.from=n,b.to=i,l.length=c,s.current=b,b.reduceCount=v,"$end"===w?0===c?(e=b.first,b.useType("end"),b.last=e,b.value=[e.value],b.rule=u.root,b.reduceCount=1,s.params=b,3):(s.params="Failed last reduce",0):(l[c++]=[p,b],s.returns=!0,p=d[p][w],a=d[p],w=r.name,s.pstate=p,w in a?1:p in h?2:(s.params="failed reduce! inside :reduce",0))},":success":function(r){var e=this;return e.completed=e.returns=!0,e.current=r,!1},":fail":function(r){var e=this;return e.error=r,e.completed=!0,!1},isAcceptableToken:function(r){return!(r[0]in this.parser.map.exclude)},update:function(r){var e=this,t=e.current;return!e.error&&t&&(t.value=r),this},reset:function(){var r=this.parser;this.nextTokenIndex=0,this.cursor=0,this.buffer=[],this.state=this.start,this.pstate=r.map.start,this.params=null,this.subject||delete this.ready,delete this.complete,delete this.error,delete this.returns,delete this.current},set:function(r){if(!e.string(r))throw new Error("Invalid String subject parameter.");this.reset(),this.subject=r,this.ready=!0},next:function(){var r,t,n,i,a,o=this,s=o.actions,u=e.number,l=o.completed,f=!1;for(l||delete o.current;!l;){if(r=o.state,t=o.params,!(r in o))throw new Error("No handler found for state "+r);if(n=o[r](t),f=o.returns,delete o.returns,a=o.current,l=o.completed,o.error)break;if(!l){if(!u(n))throw new Error("Invalid result from state handler"+r);if(i=s[r],!(n in i))throw new Error("Invalid result from state handler"+r);o.state=i[n]}if(!0===f)return a}return!(o.error||!l)&&null}};var b={};h("base",c),p.prototype={subject:"",tokenizer:null,map:null,ready:!1,constructor:p,iterator:function(r){var e,t=d;if(arguments.length){if(!(e=t(r)))throw new Error("Invalid iterator name parameter.")}else e=t("base");return new e(this)},define:function(r,t,n){var i,a=e.array;if(a(n)||(n=[]),!e.string(r))throw new Error("Invalid root grammar rule parameter.");if(!a(t))throw new Error("Invalid grammar rules definition parameter");return this.ready=i=l(r,this.map,this.tokenizer,t,n),i},fromJSON:function(r){var t,n=e.object;if(e.string(r))try{r=JSON.parse(r)}catch(r){throw new Error("Invalid JSON String json parameter.")}if(!n(r))throw new Error("Invalid Object json parameter.");if(t=r.tokens,!n(t))throw new Error('Invalid "tokens" property of json parameter.');return this.tokenizer.fromJSON(t),this.map.importStates(r),this},toJSON:function(){return JSON.stringify(this.toObject())},toObject:function(){var r;if(!this.ready)throw new Error("Grammar rules is not yet defined.");return r=this.map.toObject(),r.tokens=this.tokenizer.toObject(),r},parse:function(r,t,n){var i,a,o,s=e.string,u=[],l=0;if(!s(r))throw new Error("Invalid string subject parameter");if(!(n=s(n)?this.iterator(n):this.iterator()))throw new Error("Invalid Iterator parameter.");for(e.object(t)||(t={}),n.set(r),i=n.next();i;i=n.next())u[l++]=i,(a=i.name)in t&&(void 0!==(o=t[a](a,i.value,i))?i.value=o:0!==i.params&&(i.value=null));return!n.error&&u}};var x=Object.freeze({Parser:p,define:m,load:w,isParser:v,Iterator:c,registerIterator:h});r.default=x,r.Parser=p,r.define=m,r.load=w,r.isParser=v,r.Iterator=c,r.registerIterator=h,Object.defineProperty(r,"__esModule",{value:!0})});
//# sourceMappingURL=libcore-parser-lalr.min.js.map
