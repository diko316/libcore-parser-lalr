!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("libcore"),require("libcore-tokenizer")):"function"==typeof define&&define.amd?define(["exports","libcore","libcore-tokenizer"],t):t(e["libcore-parser-lalr"]={},e.libcore,e["libcore-tokenizer"])}(this,function(e,t,r){"use strict";function n(){var e={};this.stateGen=this.symbolGen=this.reduceGen=0,e.$start={},this.root="$end",this.lookup={},this.symbol={},this.start="$start",this.states=e,this.anchors={},this.ends={},this.exclude={},this.finalized=!1,this.rawStates=[],this.reduceLookup={},this.reducers={},this.augmentedRoot=this.generateSymbol("$end"),this.endSymbol=this.generateSymbol("$"),this.endToken="$"}function i(){}function o(e){var t=i;return t.prototype=e,new t}function s(e,t){this.item=e,this.to=t}function a(e,t){var r=t.rawStates;this.map=t,this.state=e=e||t.generateState(),this.base=this,this.watched=[],this.reduceList=[],this.recursion={},this.references=[],this.lexeme=t.augmentedRoot,r[r.length]=this}function u(e,t,r){var n,i,o,s,u,l,c,h,f,d,m=1,p=e.rules,w=e.ruleGroup;for(r&&t.setExcludes(r),c=new a(t.start,t);m;)switch(m){case 1:if(!c){m=0;break}n=c,o=p[i=c.lexeme],m=2,f=null;case 2:if(!o){m=5;break}if(u=o[0],s=o[1],o=o[2],!1===u){l=0,c=d=n;break}if(l++,s in p){if(h=d.getRecursionItem(u)){for(h.watchItem(d);o&&!1!==o[0];o=o[2]);break}h=d.createRecursion(u,s),c===n?c.insertNextQueue(h):f?f.appendQueue(h):f=h}d=d.point(s),o&&!1!==o[0]||d.reduce(i,l,w[u]);break;case 5:f&&c.appendQueue(f),c=c.nextInQueue,m=1}return!0}function l(e,r,n,i){var o,s,a,u,l,c,h,f,d,m,p=n.rules,w=n.ruleIndex,v=n.terminal,b=n.lexIndex,y=n.ruleNames,I=g,x=n.map,k=t.string,S=t.regex;if((k(r)||S(r))&&(r=[r]),!t.array(r))throw new Error("Invalid grammar rule found in "+e);for(h=f=null,a=[],o=r.length;o--;){if(s=r[o],S(s))s.source,(u=x.generateSymbol("/"+s.source+"/"))in v||(i.define([u,s]),v[u]=u),s=u;else{if(!k(s))throw new Error("Invalid token in grammar rule "+s);if(!I.test(s))throw new Error("Invalid grammar rule name format: "+s);s=x.generateSymbol(s)}a[o]=s,b[m="r"+ ++n.rgenId]=s,l=[m,s,h],h||(f=l),h=l}if(c=" -> "+a.join(","),e+":",(u=e+c)in w)throw new Error("Grammar rule is already defined "+e+c);return w[u]=!0,e in p||(p[e]=null,y[y.length]=e),h=[!1,null,h],(d=p[e])&&(f[2]=d),p[e]=h,[h[2][0],f[0]]}function c(e,r,n,i,o){var s,a,c,h,f,d,m,p,w,v,b=t.string,y=t.array,I=t.regex,x=l,k=g,S="$"+e;for(r.reset(),r.root=r.generateSymbol(S),f=null,p={root:S,rgenId:0,map:r,ruleNames:[],rules:m={},terminal:v={},lexIndex:{},ruleIndex:{},ruleGroup:w={}},i.splice(i.length,0,r.lookupSymbol(r.augmentedRoot),[[e,r.lookupSymbol(r.endSymbol)]]),s=-1,a=i.length;a--;)if(d=i[++s],b(d)){if(!k.test(d))throw new Error("Invalid grammar rule name "+d);f=r.generateSymbol(d)}else{if(!y(d))throw new Error("Invalid item in definitions parameter.");if(!f)throw new Error("Invalid grammar rules parameter.");for(c=-1,h=d.length;h--;)w[x(f,d[++c],p,n)[1]]=f+":"+(c+1)}if(o)for(a=(o=o.slice(0)).length;a--;){if(d=o[a],!I(d))throw new Error("Invalid exclude token parameter.");(f=r.generateSymbol("/"+d.source+"/"))in v?o.splice(a,1):(n.define([f,d]),v[f]=f,o[a]=f)}if(!t.contains(m,r.generateSymbol(e)))throw new Error("Invalid root grammar rule parameter.");return u(p,r,o)&&r.finalize()}function h(e){this.useType(e)}function f(e){if(!t.object(e))throw new Error("Invalid parser parameter.");this.parser=e,this.reset(),this.start=":start"}function d(e,r){var n=f;if(!t.string(e))throw new Error("Invalid iterator name parameter.");if(!t.method(r)||r!==n&&!(r.prototype instanceof n))throw new Error("Invalid iterator Class parameter.");return I[":"+e]=r,!0}function m(e){var r=I;return t.string(e)&&(e=":"+e)in r?r[e]:null}function p(e,t,i){this.tokenizer=new r,this.map=new n,arguments.length&&this.define(e,t,i)}function w(e,t,r){return new p(e,t,r)}function v(e){var r;if(t.string(e))try{e=JSON.parse(e)}catch(e){throw new Error("Unable to load from invalid json JSON String parameter: "+e.toString())}else if(!t.object(e))throw new Error("Unable to load from invalid json Object parameter.");r=new p;try{r.fromJSON(e)}catch(e){throw new Error(e)}return r}function b(e){return e instanceof p}r=r&&r.hasOwnProperty("default")?r.default:r,n.prototype={stateGen:0,rawStates:null,constructor:n,generateState:function(){var e="s"+ ++this.stateGen;return this.states[e]={},e},generateSymbol:function(e){var t,r=this.lookup,n=this.symbol,i=":"+e;return i in r?r[i]:(t="s>"+ ++this.symbolGen,r[i]=t,n[t]=e,t)},generateReduceId:function(e,t,r){var n,i=this.reduceLookup,o=this.reducers,s=e+":"+t+":"+r;return s in i?i[s]:(n="r>"+ ++this.reduceGen,i[s]=n,o[n]=[e,t,r],n)},lookupReducer:function(e){var t=this.reducers;return e in t&&t[e]},lookupSymbol:function(e){var t=this.symbol;return e in t&&t[e]},setAnchorState:function(e){e in this.anchors||(this.anchors[e]=!0)},setReduceState:function(e,t,r,n){var i,o=this.ends,s=this.generateReduceId(t,r,n),a=this.reducers;if(e in o){if((i=a[o[e]])[0]!==t||i[1]!==r)throw new Error("Reduce conflict found "+i[0]+" ! <- "+t)}else o[e]=s},reset:function(){this.constructor()},finalize:function(){var e,t,r=this.rawStates;if(!this.finalized&&r){for(this.finalized=!0,e=-1,t=r.length;t--;)r[++e].finalize();r.length=0,delete this.lookup}return this.finalized},setExcludes:function(e){var r,n,i=this.exclude;if(t.array(e))for(r=-1,n=e.length;n--;)i[e[++r]]=!0},importStates:function(e){var r,n,i,o,s,a,u,l,c,h,f,d=t.object,m=t.string;if(!d(e))throw new Error("Invalid Object definition parameter.");if(n=e.states,!d(n))throw new Error('Invalid "states" Object in definition parameter.');if(s=e.root,!m(s))throw new Error('Invalid "root" grammar rule in definition parameter.');if(r=e.start,!(m(r)&&r in n))throw new Error('Invalid "start" state in definition parameter.');if(i=e.anchors,!d(i))throw new Error('Invalid "anchors" states in definition parameter.');if(o=e.ends,!d(i))throw new Error('Invalid "ends" states in definition parameter.');if(l=e.reducers,!d(l))throw new Error('Invalid production "reducers" in definition.');if(u=e.symbol,!d(u))throw new Error('Invalid "symbol" map in definition parameter.');if(c=e.exclude,!t.array(c))throw new Error('Invalid "exclude" token in definition parameter.');for(a={},h=-1,f=c.length;f--;)a[c[++h]]=!0;return this.root=s,this.start=r,this.states=n,this.anchors=i,this.ends=o,this.reducers=l,this.exclude=a,this.symbol=u,!0},toObject:function(){var e,r=t.contains,n=this.exclude,i=[],o=0;for(e in n)r(n,e)&&(i[o++]=e);return{root:this.root,start:this.start,states:this.states,anchors:this.anchors,reducers:this.reducers,ends:this.ends,exclude:i,symbol:this.symbol}},exportStates:function(e){var t=this.toObject();if(!0===e)try{return JSON.stringify(t)}catch(e){return null}return t}},s.prototype={constructor:s,next:null,item:null,to:null},a.prototype={state:null,constructor:a,nextInQueue:null,parent:null,map:null,pointer:null,watched:null,contextPointer:null,reduceList:null,lexeme:null,recursion:null,finalized:!1,getRecursionItem:function(e){var t=this.recursion;return e in t?t[e]:null},insertNextQueue:function(e){var t=this.nextInQueue,r=e;for(this.nextInQueue=e;r.nextInQueue;r=r.nextInQueue);r.nextInQueue=t},appendQueue:function(e){for(var t=this;t.nextInQueue;t=t.nextInQueue);t.nextInQueue=e},createRecursion:function(e,t){var r=o(this),n=this.recursion;return r.parent=this,r.lexeme=t,r.recursion=n,n[e]=r,r.contextPointer=r.nextInQueue=null,r},getPointerItem:function(e){for(var t=this.pointer;t;t=t.next)if(t.item===e)return t.to;return null},point:function(e){var t,r,n,i,o=s,u=this.getPointerItem(e);if(!u)for((u=new a(null,this.map)).lexeme=e,u.recursion=this.recursion,this.onSetPointer(new o(e,u)),r=-1,n=(t=this.watched).length;n--;)(i=t[++r]).getPointerItem(e)||i.onSetPointer(new o(e,u));return u},watchItem:function(e){var t,r,n=this.watched,i=s;if(e.state!==this.state&&-1===n.indexOf(e))for(n[n.length]=e,t=this.pointer;t;t=t.next)r=t.item,e.getPointerItem(r)||e.onSetPointer(new i(r,t.to))},onSetPointer:function(e){var t,r=this.pointer,n=this.contextPointer;if(r){for(;r.next;r=r.next);r.next=e}else this.base.pointer=e;if(!n)for(t=this;t;t=t.parent)t.contextPointer||(t.contextPointer=e)},finalize:function(){var e,t,r,n,i,o=this.map,s=this.state,a=o.states[s];for(n=this.pointer;n;n=n.next)(i=n.item)in a||(a[i]=n.to.state);for(t=-1,r=(e=this.reduceList).length;r--;)n=e[++t],o.setReduceState(s,n[0],n[1],n[2])},reduce:function(e,t,r){var n=this.reduceList;n[n.length]=[e,t,r]}};var g=/^([A-Z][a-zA-Z]+(\_?[a-zA-Z0-9])*|\$end|\$)$/,y={terminal:1,nonterminal:2,compound:3,end:4};h.prototype={constructor:h,name:null,rule:null,value:null,reduceCount:0,from:0,to:0,parent:null,first:null,last:null,next:null,previous:null,useType:function(e){var r=y;this.type=t.contains(r,e)?r[e]:r.token}};f.prototype={constructor:f,subject:"",returns:!1,current:null,ready:!1,completed:!1,error:null,actions:{":start":{0:":fail",1:":tokenize"},":tokenize":{0:":fail",1:":tokenize",2:":shift",3:":reduce"},":shift":{0:":fail",1:":tokenize"},":reduce":{0:":fail",1:":shift",2:":reduce",3:":success"},":fail":{},":success":{}},":start":function(){var e=this;return e.params=e.nextTokenIndex,1},":tokenize":function(e){var t,r,n,i,o,s=this,a=s.parser,u=a.map,l=u.ends,c=u.states,f=s.pstate,d=a.tokenizer.tokenize(e,s.subject),m=u.endToken;if(d){if(t=d[0],r=d[2],!this.isAcceptableToken(d))return s.params=r,1;if(i=new h("terminal"),o=t,t===m?t=u.endSymbol:o=u.symbol[t],i.name=o,i.symbol=t,i.value=d[1],i.from=e,i.to=r,s.nextTokenIndex=r,s.params=i,n=c[f],t in n)return 2}return s.buffer.length&&f in l?3:(s.params="Invalid token",0)},":shift":function(e){var t=this,r=t.buffer,n=t.parser.map,i=n.states,o=t.pstate,s=e.symbol;return r[r.length]=[o,e],t.pstate=i[o][s],t.current=e,t.params=null,t.returns=s!==n.endSymbol,t.params=t.nextTokenIndex,1},":reduce":function(e){var t,r,n,i,o,s,a=this,u=a.parser.map,l=a.buffer,c=l.length,f=u.ends,d=u.states,m=u.symbol,p=a.pstate,w=u.lookupReducer(f[p]),v=w[0],b=w[1],g=b,y=g-1,I=new h("nonterminal"),x=[];for(I.name=m[v],I.symbol=v,I.rule=w[2],s=null;g--;)p=(r=l[--c])[0],n=(t=r[1]).from,g===y&&(i=t.to),t.parent=I,s?(s.previous=t,t.next=s):I.last=t,I.first=s=t,x[g]=t.value;return I.value=x,I.from=n,I.to=i,l.length=c,a.current=I,I.reduceCount=b,v===u.augmentedRoot?0===c?(t=I.first,I.useType("end"),I.last=t,I.value=[t.value],I.rule=u.root,I.reduceCount=1,a.params=I,3):(a.params="Failed last reduce",0):(l[c++]=[p,I],a.returns=!0,p=d[p][v],o=d[p],v=e.symbol,a.pstate=p,v in o?1:p in f?2:(a.params="failed reduce! inside :reduce",0))},":success":function(e){var t=this;return t.completed=t.returns=!0,t.current=e,!1},":fail":function(e){var t=this;return t.error=e,t.completed=!0,!1},isAcceptableToken:function(e){return!(e[0]in this.parser.map.exclude)},update:function(e){var t=this,r=t.current;return!t.error&&r&&(r.value=e),this},reset:function(){var e=this.parser;this.nextTokenIndex=0,this.cursor=0,this.buffer=[],this.state=this.start,this.pstate=e.map.start,this.params=null,this.subject||delete this.ready,delete this.complete,delete this.error,delete this.returns,delete this.current},set:function(e){if(!t.string(e))throw new Error("Invalid String subject parameter.");this.reset(),this.subject=e,this.ready=!0},next:function(){var e,r,n,i,o,s=this,a=s.actions,u=t.number,l=s.completed,c=!1;for(l||delete s.current;!l;){if(e=s.state,r=s.params,!(e in s))throw new Error("No handler found for state "+e);if(n=s[e](r),c=s.returns,delete s.returns,o=s.current,l=s.completed,s.error)break;if(!l){if(!u(n))throw new Error("Invalid result from state handler"+e);if(i=a[e],!(n in i))throw new Error("Invalid result from state handler"+e);s.state=i[n]}if(!0===c)return o}return!(s.error||!l)&&null}};var I={};d("base",f),p.prototype={subject:"",tokenizer:null,map:null,ready:!1,constructor:p,iterator:function(e){var t,r=m;if(arguments.length){if(!(t=r(e)))throw new Error("Invalid iterator name parameter.")}else t=r("base");return new t(this)},define:function(e,r,n){var i,o=t.array;if(o(n)||(n=[]),!t.string(e))throw new Error("Invalid root grammar rule parameter.");if(!o(r))throw new Error("Invalid grammar rules definition parameter");return this.ready=i=c(e,this.map,this.tokenizer,r,n),i},fromJSON:function(e){var r,n=t.object;if(t.string(e))try{e=JSON.parse(e)}catch(e){throw new Error("Invalid JSON String json parameter.")}if(!n(e))throw new Error("Invalid Object json parameter.");if(r=e.tokens,!n(r))throw new Error('Invalid "tokens" property of json parameter.');return this.tokenizer.fromJSON(r),this.map.importStates(e),this},toJSON:function(){return JSON.stringify(this.toObject())},toObject:function(){var e;if(!this.ready)throw new Error("Grammar rules is not yet defined.");return e=this.map.toObject(),e.tokens=this.tokenizer.toObject(),e},parse:function(e,r,n){var i,o,s,a=t.string,u=[],l=0;if(!a(e))throw new Error("Invalid string subject parameter");if(!(n=a(n)?this.iterator(n):this.iterator()))throw new Error("Invalid Iterator parameter.");for(t.object(r)||(r={}),n.set(e),i=n.next();i;i=n.next())u[l++]=i,(o=i.name)in r&&(void 0!==(s=r[o](o,i.value,i))?i.value=s:0!==i.params&&(i.value=null));return!n.error&&u}};var x=Object.freeze({Parser:p,define:w,load:v,isParser:b,Iterator:f,registerIterator:d});e.default=x,e.Parser=p,e.define=w,e.load=v,e.isParser=b,e.Iterator=f,e.registerIterator=d,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=libcore-parser-lalr.min.js.map
