!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("libcore"),require("libcore-tokenizer")):"function"==typeof define&&define.amd?define(["exports","libcore","libcore-tokenizer"],t):t(e["libcore-parser-lalr"]={},e.libcore,e["libcore-tokenizer"])}(this,function(e,t,r){"use strict";function n(){var e={};this.stateGen=this.symbolGen=this.reduceGen=0,e.$start={},this.root="$end",this.lookup={},this.symbol={},this.start="$start",this.states=e,this.anchors={},this.ends={},this.exclude={},this.finalized=!1,this.rawStates=[],this.reduceLookup={},this.reducers={},this.augmentedRoot=this.generateSymbol("$end"),this.endSymbol=this.generateSymbol("$"),this.endToken="$"}function i(){}function o(e){var t=i;return t.prototype=e,new t}function s(e,t){this.item=e,this.to=t}function a(e,t){var r=t.rawStates;this.map=t,this.state=e=e||t.generateState(),this.base=this,this.watched=[],this.reduceList=[],this.recursion={},this.references=[],this.lexeme=t.augmentedRoot,r[r.length]=this}function u(e,t,r){var n,i,o,s,u,l,h,c,f,d,m=1,p=e.rules,w=e.ruleGroup;for(r&&t.setExcludes(r),h=new a(t.start,t);m;)switch(m){case 1:if(!h){m=0;break}n=h,o=p[i=h.lexeme],m=2,f=null;case 2:if(!o){m=5;break}if(u=o[0],s=o[1],o=o[2],!1===u){l=0,h=d=n;break}if(l++,s in p){if(c=d.getRecursionItem(u)){for(c.watchItem(d);o&&!1!==o[0];o=o[2]);break}c=d.createRecursion(u,s),h===n?h.insertNextQueue(c):f?f.appendQueue(c):f=c}d=d.point(s),o&&!1!==o[0]||d.reduce(i,l,w[u]);break;case 5:f&&h.appendQueue(f),h=h.nextInQueue,m=1}return!0}function l(e,t,r){var n,i,o=e.terminal,s=e.tokenAlias,a=e.tokens,u=e.map,l=e.pendingTerminals;if(n=u.generateSymbol("/"+t.source+"/"),r||(r=n),n in s){if(s[n]!==r)throw new Error("Token definition "+t.source+" is a duplicate of "+u.lookupSymbol(s[n]))}else s[n]=r,i=a.length,a[i++]=r,a[i++]=t;return r in o||(o[r]=n,-1===l.indexOf(r)&&(l[l.length]=r)),[r,n]}function h(e,r,n){var i,o,s,a=n.map,u=l,h=t.regex,c="Invalid terminal definitions in "+a.lookupSymbol(e);if(h(r)&&(r=[r]),!t.array(r))throw new Error(c);for(i=-1,o=r.length;o--;){if(s=r[++i],!h(s))throw new Error(c);u(n,s,e)}}function c(e,r,n){var i,o,s,a,u,h,c,f,d,m,p=n.rules,w=n.ruleIndex,v=n.lexIndex,b=n.ruleNames,g=x,y=n.map,I=n.pendingTerminals,k=l,S=t.string,E=t.regex;if((S(r)||E(r))&&(r=[r]),!t.array(r))throw new Error("Invalid grammar rule found in "+e);for(c=f=null,s=[],i=r.length;i--;){if(o=r[i],E(o))o=(a=k(n,o))[0];else{if(!S(o))throw new Error("Invalid token in grammar rule "+o);g.test(o)?o=y.generateSymbol(o):(o=y.generateSymbol(o),-1===I.indexOf(o)&&(I[I.length]=o))}s[i]=o,v[m="r"+ ++n.rgenId]=o,u=[m,o,c],c||(f=u),c=u}if(h=" -> "+s.join(","),e+":",(a=e+h)in w)throw new Error("Grammar rule is already defined "+e+h);return w[a]=!0,e in p||(p[e]=null,b[b.length]=e),c=[!1,null,c],(d=p[e])&&(f[2]=d),p[e]=c,[c[2][0],f[0]]}function f(e,r,n,i,o){var s,a,f,d,m,p,w,v,b,g=t.string,y=t.array,I=t.regex,k=c,S=h,E=l,j={},z=x,O="$"+e,P=null,Q=[],T=[],N=!1;for(r.reset(),r.root=r.generateSymbol(O),w={root:O,rgenId:0,map:r,ruleNames:[],rules:j,terminal:b={},tokens:Q,tokenAlias:{},pendingTerminals:T,lexIndex:{},ruleIndex:{},ruleGroup:v={}},i.splice(i.length,0,r.lookupSymbol(r.augmentedRoot),[[e,r.lookupSymbol(r.endSymbol)]]),s=-1,a=i.length;a--;)if(m=i[++s],g(m))N=!z.test(m),P=r.generateSymbol(m);else{if(!y(m))throw new Error("Invalid item in definitions parameter.");if(!P)throw new Error("Invalid grammar rules parameter.");for(f=-1,d=m.length;d--;)N?S(P,m[++f],w):v[k(P,m[++f],w,n)[1]]=P+":"+(f+1)}if(o)for(o=o.slice(0),p=T.length,a=o.length;a--;){if(m=o[a],g(m))P=r.generateSymbol(m),-1===T.indexOf(P)&&(T[p++]=P);else{if(!I(m))throw new Error("Invalid exclude token parameter.");P=(m=E(w,m,null,!0))[0]}o[a]=P}for(p=T.length;p--;)if(!((P=T[p])in b))throw new Error("Terminal is not defined ",r.lookupSymbol(P));if(T.length=0,Q.length&&n.define(Q),!t.contains(j,r.generateSymbol(e)))throw new Error("Invalid root grammar rule parameter.");return u(w,r,o)&&r.finalize()}function d(e){this.useType(e)}function m(e){if(!t.object(e))throw new Error("Invalid parser parameter.");this.parser=e,this.reset(),this.start=":start"}function p(e,r){var n=m;if(!t.string(e))throw new Error("Invalid iterator name parameter.");if(!t.method(r)||r!==n&&!(r.prototype instanceof n))throw new Error("Invalid iterator Class parameter.");return k[":"+e]=r,!0}function w(e){var r=k;return t.string(e)&&(e=":"+e)in r?r[e]:null}function v(e,t,i){this.tokenizer=new r,this.map=new n,arguments.length&&this.define(e,t,i)}function b(e,t,r){return new v(e,t,r)}function g(e){var r;if(t.string(e))try{e=JSON.parse(e)}catch(e){throw new Error("Unable to load from invalid json JSON String parameter: "+e.toString())}else if(!t.object(e))throw new Error("Unable to load from invalid json Object parameter.");r=new v;try{r.fromJSON(e)}catch(e){throw new Error(e)}return r}function y(e){return e instanceof v}r=r&&r.hasOwnProperty("default")?r.default:r,n.prototype={stateGen:0,rawStates:null,constructor:n,generateState:function(){var e="s"+ ++this.stateGen;return this.states[e]={},e},generateSymbol:function(e){var t,r=this.lookup,n=this.symbol,i=":"+e;return i in r?r[i]:(t="s>"+ ++this.symbolGen,r[i]=t,n[t]=e,t)},generateReduceId:function(e,t,r){var n,i=this.reduceLookup,o=this.reducers,s=e+":"+t+":"+r;return s in i?i[s]:(n="r>"+ ++this.reduceGen,i[s]=n,o[n]=[e,t,r],n)},lookupReducer:function(e){var t=this.reducers;return e in t&&t[e]},lookupSymbol:function(e){var t=this.symbol;return e in t&&t[e]},setAnchorState:function(e){e in this.anchors||(this.anchors[e]=!0)},setReduceState:function(e,t,r,n){var i,o=this.ends,s=this.generateReduceId(t,r,n),a=this.reducers;if(e in o){if((i=a[o[e]])[0]!==t||i[1]!==r)throw new Error("Reduce conflict found "+i[0]+" ! <- "+t)}else o[e]=s},reset:function(){this.constructor()},finalize:function(){var e,t,r=this.rawStates;if(!this.finalized&&r){for(this.finalized=!0,e=-1,t=r.length;t--;)r[++e].finalize();r.length=0,delete this.lookup}return this.finalized},setExcludes:function(e){var r,n,i=this.exclude;if(t.array(e))for(r=-1,n=e.length;n--;)i[e[++r]]=!0},importStates:function(e){var r,n,i,o,s,a,u,l,h,c,f,d=t.object,m=t.string;if(!d(e))throw new Error("Invalid Object definition parameter.");if(n=e.states,!d(n))throw new Error('Invalid "states" Object in definition parameter.');if(s=e.root,!m(s))throw new Error('Invalid "root" grammar rule in definition parameter.');if(r=e.start,!(m(r)&&r in n))throw new Error('Invalid "start" state in definition parameter.');if(i=e.anchors,!d(i))throw new Error('Invalid "anchors" states in definition parameter.');if(o=e.ends,!d(i))throw new Error('Invalid "ends" states in definition parameter.');if(l=e.reducers,!d(l))throw new Error('Invalid production "reducers" in definition.');if(u=e.symbol,!d(u))throw new Error('Invalid "symbol" map in definition parameter.');if(h=e.exclude,!t.array(h))throw new Error('Invalid "exclude" token in definition parameter.');for(a={},c=-1,f=h.length;f--;)a[h[++c]]=!0;return this.root=s,this.start=r,this.states=n,this.anchors=i,this.ends=o,this.reducers=l,this.exclude=a,this.symbol=u,!0},toObject:function(){var e,r=t.contains,n=this.exclude,i=[],o=0;for(e in n)r(n,e)&&(i[o++]=e);return{root:this.root,start:this.start,states:this.states,anchors:this.anchors,reducers:this.reducers,ends:this.ends,exclude:i,symbol:this.symbol}},exportStates:function(e){var t=this.toObject();if(!0===e)try{return JSON.stringify(t)}catch(e){return null}return t}},s.prototype={constructor:s,next:null,item:null,to:null},a.prototype={state:null,constructor:a,nextInQueue:null,parent:null,map:null,pointer:null,watched:null,contextPointer:null,reduceList:null,lexeme:null,recursion:null,finalized:!1,getRecursionItem:function(e){var t=this.recursion;return e in t?t[e]:null},insertNextQueue:function(e){var t=this.nextInQueue,r=e;for(this.nextInQueue=e;r.nextInQueue;r=r.nextInQueue);r.nextInQueue=t},appendQueue:function(e){for(var t=this;t.nextInQueue;t=t.nextInQueue);t.nextInQueue=e},createRecursion:function(e,t){var r=o(this),n=this.recursion;return r.parent=this,r.lexeme=t,r.recursion=n,n[e]=r,r.contextPointer=r.nextInQueue=null,r},getPointerItem:function(e){for(var t=this.pointer;t;t=t.next)if(t.item===e)return t.to;return null},point:function(e){var t,r,n,i,o=s,u=this.getPointerItem(e);if(!u)for((u=new a(null,this.map)).lexeme=e,u.recursion=this.recursion,this.onSetPointer(new o(e,u)),r=-1,n=(t=this.watched).length;n--;)(i=t[++r]).getPointerItem(e)||i.onSetPointer(new o(e,u));return u},watchItem:function(e){var t,r,n=this.watched,i=s;if(e.state!==this.state&&-1===n.indexOf(e))for(n[n.length]=e,t=this.pointer;t;t=t.next)r=t.item,e.getPointerItem(r)||e.onSetPointer(new i(r,t.to))},onSetPointer:function(e){var t,r=this.pointer,n=this.contextPointer;if(r){for(;r.next;r=r.next);r.next=e}else this.base.pointer=e;if(!n)for(t=this;t;t=t.parent)t.contextPointer||(t.contextPointer=e)},finalize:function(){var e,t,r,n,i,o=this.map,s=this.state,a=o.states[s];for(n=this.pointer;n;n=n.next)(i=n.item)in a||(a[i]=n.to.state);for(t=-1,r=(e=this.reduceList).length;r--;)n=e[++t],o.setReduceState(s,n[0],n[1],n[2])},reduce:function(e,t,r){var n=this.reduceList;n[n.length]=[e,t,r]}};var x=/^([A-Z][a-zA-Z]+(\_?[a-zA-Z0-9])*|\$end|\$)$/,I={terminal:1,nonterminal:2,compound:3,end:4};d.prototype={constructor:d,name:null,rule:null,value:null,reduceCount:0,from:0,to:0,parent:null,first:null,last:null,next:null,previous:null,useType:function(e){var r=I;this.type=t.contains(r,e)?r[e]:r.token}};m.prototype={constructor:m,subject:"",returns:!1,current:null,ready:!1,completed:!1,error:null,actions:{":start":{0:":fail",1:":tokenize"},":tokenize":{0:":fail",1:":tokenize",2:":shift",3:":reduce"},":shift":{0:":fail",1:":tokenize"},":reduce":{0:":fail",1:":shift",2:":reduce",3:":success"},":fail":{},":success":{}},":start":function(){var e=this;return e.params=e.nextTokenIndex,1},":tokenize":function(e){var t,r,n,i,o,s=this,a=s.parser,u=a.map,l=u.ends,h=u.states,c=s.pstate,f=a.tokenizer.tokenize(e,s.subject),m=u.endToken;if(f){if(t=f[0],r=f[2],!this.isAcceptableToken(f))return s.params=r,1;if(i=new d("terminal"),o=t,t===m?t=u.endSymbol:o=u.symbol[t],i.name=o,i.symbol=t,i.value=f[1],i.from=e,i.to=r,s.nextTokenIndex=r,s.params=i,n=h[c],t in n)return 2}return s.buffer.length&&c in l?3:(s.params="Invalid token",0)},":shift":function(e){var t=this,r=t.buffer,n=t.parser.map,i=n.states,o=t.pstate,s=e.symbol;return r[r.length]=[o,e],t.pstate=i[o][s],t.current=e,t.params=null,t.returns=s!==n.endSymbol,t.params=t.nextTokenIndex,1},":reduce":function(e){var t,r,n,i,o,s,a=this,u=a.parser.map,l=a.buffer,h=l.length,c=u.ends,f=u.states,m=u.symbol,p=a.pstate,w=u.lookupReducer(c[p]),v=w[0],b=w[1],g=b,y=g-1,x=new d("nonterminal"),I=[];for(x.name=m[v],x.symbol=v,x.rule=w[2],s=null;g--;)p=(r=l[--h])[0],n=(t=r[1]).from,g===y&&(i=t.to),t.parent=x,s?(s.previous=t,t.next=s):x.last=t,x.first=s=t,I[g]=t.value;return x.value=I,x.from=n,x.to=i,l.length=h,a.current=x,x.reduceCount=b,v===u.augmentedRoot?0===h?(t=x.first,x.useType("end"),x.last=t,x.value=[t.value],x.rule=u.root,x.reduceCount=1,a.params=x,3):(a.params="Failed last reduce",0):(l[h++]=[p,x],a.returns=!0,p=f[p][v],o=f[p],v=e.symbol,a.pstate=p,v in o?1:p in c?2:(a.params="failed reduce! inside :reduce",0))},":success":function(e){var t=this;return t.completed=t.returns=!0,t.current=e,!1},":fail":function(e){var t=this;return t.error=e,t.completed=!0,!1},isAcceptableToken:function(e){return!(e[0]in this.parser.map.exclude)},update:function(e){var t=this,r=t.current;return!t.error&&r&&(r.value=e),this},reset:function(){var e=this.parser;this.nextTokenIndex=0,this.cursor=0,this.buffer=[],this.state=this.start,this.pstate=e.map.start,this.params=null,this.subject||delete this.ready,delete this.complete,delete this.error,delete this.returns,delete this.current},set:function(e){if(!t.string(e))throw new Error("Invalid String subject parameter.");this.reset(),this.subject=e,this.ready=!0},next:function(){var e,r,n,i,o,s=this,a=s.actions,u=t.number,l=s.completed,h=!1;for(l||delete s.current;!l;){if(e=s.state,r=s.params,!(e in s))throw new Error("No handler found for state "+e);if(n=s[e](r),h=s.returns,delete s.returns,o=s.current,l=s.completed,s.error)break;if(!l){if(!u(n))throw new Error("Invalid result from state handler"+e);if(i=a[e],!(n in i))throw new Error("Invalid result from state handler"+e);s.state=i[n]}if(!0===h)return o}return!(s.error||!l)&&null}};var k={};p("base",m),v.prototype={subject:"",tokenizer:null,map:null,ready:!1,constructor:v,iterator:function(e){var t,r=w;if(arguments.length){if(!(t=r(e)))throw new Error("Invalid iterator name parameter.")}else t=r("base");return new t(this)},define:function(e,r,n){var i,o=t.array;if(o(n)||(n=[]),!t.string(e))throw new Error("Invalid root grammar rule parameter.");if(!o(r))throw new Error("Invalid grammar rules definition parameter");return this.ready=i=f(e,this.map,this.tokenizer,r,n),i},fromJSON:function(e){var r,n=t.object;if(t.string(e))try{e=JSON.parse(e)}catch(e){throw new Error("Invalid JSON String json parameter.")}if(!n(e))throw new Error("Invalid Object json parameter.");if(r=e.tokens,!n(r))throw new Error('Invalid "tokens" property of json parameter.');return this.tokenizer.fromJSON(r),this.map.importStates(e),this},toJSON:function(){return JSON.stringify(this.toObject())},toObject:function(){var e;if(!this.ready)throw new Error("Grammar rules is not yet defined.");return e=this.map.toObject(),e.tokens=this.tokenizer.toObject(),e},parse:function(e,r,n){var i,o,s,a=t.string,u=[],l=0;if(!a(e))throw new Error("Invalid string subject parameter");if(!(n=a(n)?this.iterator(n):this.iterator()))throw new Error("Invalid Iterator parameter.");for(t.object(r)||(r={}),n.set(e),i=n.next();i;i=n.next())u[l++]=i,(o=i.name)in r&&(void 0!==(s=r[o](o,i.value,i))?i.value=s:0!==i.params&&(i.value=null));return!n.error&&u}};var S=Object.freeze({Parser:v,define:b,load:g,isParser:y,Iterator:m,registerIterator:p});e.default=S,e.Parser=v,e.define=b,e.load=g,e.isParser=y,e.Iterator=m,e.registerIterator=p,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=libcore-parser-lalr.min.js.map
